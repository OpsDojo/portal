name: Deliver
on:
  push:
    tags: ['v[0-9]+*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v1.2.3)'
        required: true
  
jobs:
  deliver:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        component:
          - { name: "api", path: "./apps/portal-api", dockerdir: "./Portal.Host" }
          - { name: "ui", path: "./apps/portal-ui", dockerdir: "." }
    steps:
    - name: Checkout self
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # full history (supports github releases)

    - name: Fail if not main branch
      run: git merge-base --is-ancestor ${{ github.sha }} origin/main

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Docker build and push ${{ matrix.component.name }}
      working-directory: ${{ matrix.component.path }}
      run: |
        VERSION=${{ inputs.version || github.ref_name }}
        OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_NAME=ghcr.io/$OWNER/portal-${{ matrix.component.name }}
        
        docker build --push \
                     -f ${{ matrix.component.dockerdir }}/Dockerfile \
                     -t $IMAGE_NAME:latest \
                     -t $IMAGE_NAME:$VERSION \
                     -t $IMAGE_NAME:${{ github.sha }} \
                     .